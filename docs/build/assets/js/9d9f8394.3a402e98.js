"use strict";(self.webpackChunkfreyja=self.webpackChunkfreyja||[]).push([[360],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>h});var n=r(7294);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var l=n.createContext({}),u=function(e){var t=n.useContext(l),r=t;return e&&(r="function"==typeof e?e(t):a(a({},t),e)),r},p=function(e){var t=u(e.components);return n.createElement(l.Provider,{value:t},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var r=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=u(r),c=o,h=m["".concat(l,".").concat(c)]||m[c]||d[c]||i;return r?n.createElement(h,a(a({ref:t},p),{},{components:r})):n.createElement(h,a({ref:t},p))}));function h(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=r.length,a=new Array(i);a[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[m]="string"==typeof e?e:o,a[1]=s;for(var u=2;u<i;u++)a[u]=r[u];return n.createElement.apply(null,a)}return n.createElement.apply(null,r)}c.displayName="MDXCreateElement"},9222:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var n=r(7462),o=(r(7294),r(3905));const i={sidebar_label:"Troubleshooting",sidebar_position:6},a="Troubleshooting",s={unversionedId:"troubleshooting",id:"troubleshooting",title:"Troubleshooting",description:"libvirt-qemu permission denied on home user",source:"@site/docs/troubleshooting.md",sourceDirName:".",slug:"/troubleshooting",permalink:"/freyja/docs/troubleshooting",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/troubleshooting.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_label:"Troubleshooting",sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"Configuration",permalink:"/freyja/docs/configuration"}},l={},u=[{value:"libvirt-qemu permission denied on home user",id:"libvirt-qemu-permission-denied-on-home-user",level:2},{value:"Qemu unexpectedly closed the monitor",id:"qemu-unexpectedly-closed-the-monitor",level:2},{value:"Apparmor",id:"apparmor",level:3},{value:"IP is &#39;unknown&#39;",id:"ip-is-unknown",level:2},{value:"Interface is &#39;unknown&#39;",id:"interface-is-unknown",level:2},{value:"OS versions are missing in <code>osinfo-query os</code>",id:"os-versions-are-missing-in-osinfo-query-os",level:2},{value:"PolicyKit",id:"policykit",level:2},{value:"Run tests",id:"run-tests",level:2},{value:"Run build",id:"run-build",level:2}],p={toc:u},m="wrapper";function d(e){let{components:t,...r}=e;return(0,o.kt)(m,(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"troubleshooting"},"Troubleshooting"),(0,o.kt)("h2",{id:"libvirt-qemu-permission-denied-on-home-user"},"libvirt-qemu permission denied on home user"),(0,o.kt)("p",null,"Creating a VM, you encounter the following error :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"WARNING  /home/user/freyja-workspace/build/almalinux/almalinux_cloud_init.iso may not be accessible by th\ne hypervisor. You will need to grant the 'libvirt-qemu' user search permissions for the following directo\nries: ['/home/user']                                \nERROR    Cannot access storage file '/home/user/freyja-workspace/build/image/image_snapshot' (as \nuid:64055, gid:109): Permission denied                                                                   \nDomain installation does not appear to have been successful.\n")),(0,o.kt)("p",null,"To solve this issue, set ACL of your host :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"setacl u:libvirt-qemu:r $HOME\ngetacl -e $HOME\n\n# file: home/user\n# owner: user\n# group: user\nuser::rwx\nuser:libvirt-qemu:r             #effective:r\ngroup::r-x                      #effective:r-x\nmask::r-x\nother::---\n")),(0,o.kt)("h2",{id:"qemu-unexpectedly-closed-the-monitor"},"Qemu unexpectedly closed the monitor"),(0,o.kt)("p",null,"These kind of issues are often due to Apparmor or Selinux."),(0,o.kt)("h3",{id:"apparmor"},"Apparmor"),(0,o.kt)("p",null,"Start by studying the error :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"sudo journalctl -xe\n")),(0,o.kt)("p",null,"You might encounter several kind of issues related to apparmor."),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"CASE 1")),(0,o.kt)("p",null,"Output of ",(0,o.kt)("inlineCode",{parentName:"p"},"journalctl")," error :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'apparmor="DENIED" operation="file_mmap" profile="virt-aa-helper" name="/opt/openssl/lib/libcrypto.so\n')),(0,o.kt)("p",null,"To solve this, you should grant ",(0,o.kt)("inlineCode",{parentName:"p"},"mmap")," permission to ",(0,o.kt)("inlineCode",{parentName:"p"},"virt-aa-helper")," for ",(0,o.kt)("inlineCode",{parentName:"p"},"libcrypto.so"),".",(0,o.kt)("br",{parentName:"p"}),"\n","Update ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/apparmor.d/usr.lib.libvirt.virt-aa-helper")," with ",(0,o.kt)("inlineCode",{parentName:"p"},"mmap")," permission for ",(0,o.kt)("inlineCode",{parentName:"p"},"libcrypto")," :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'echo "  /opt/openssl/lib/libcrypto.so.1.1 m," >> /etc/apparmor.d/usr.lib.libvirt.virt-aa-helper\nsudo systemctl restart apparmor\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"CASE 2")),(0,o.kt)("p",null,"Output of ",(0,o.kt)("inlineCode",{parentName:"p"},"journalctl")," error :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'apparmor="DENIED" operation="open" profile="libvirt-2938f233-2589-4f85-9aa8-2f1cabd92dbf" name="~/freyja-workspace/build/myvm/provisioning.ign" pid=11837 comm="qemu-system-x86" requested_mask="r" denied_mask="r" fsuid=64055 ouid=1000\n')),(0,o.kt)("p",null,"To solve this, you should grant ",(0,o.kt)("inlineCode",{parentName:"p"},"read")," permission for ",(0,o.kt)("inlineCode",{parentName:"p"},"libvirt")," for ignition files directory.\nUpdate ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/apparmor.d/abstractions/libvirt-qemu")," with ",(0,o.kt)("inlineCode",{parentName:"p"},"read")," permission for the Freyja workspace :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'echo "  /home/<user>/freyja-workspace/** r," >> /etc/apparmor.d/abstractions/libvirt-qemu\nsudo systemctl restart apparmor\n')),(0,o.kt)("h2",{id:"ip-is-unknown"},"IP is 'unknown'"),(0,o.kt)("p",null,"The first reason might be that the virtual machine is shut off. Start it to verify the IP."),(0,o.kt)("p",null,"The second reason might be that the bridge is taking time to mount the vm IP on the host interface.",(0,o.kt)("br",{parentName:"p"}),"\n","Wait a few seconds and check again."),(0,o.kt)("p",null,"The third reason might be caused by an external DHCP resolution.",(0,o.kt)("br",{parentName:"p"}),"\n","Freyja is only capable of deducing IP addresses resolved on interfaces that are related to DHCP resolution from\nlibvirt on your local host. If the interface you are using for the current machine is not related to libvirt, the IP\nresolution is made by an external server and Freyja is not able to give this information to you."),(0,o.kt)("h2",{id:"interface-is-unknown"},"Interface is 'unknown'"),(0,o.kt)("p",null,"The first reason might be that the virtual machine is shut off. Start it to verify the interface."),(0,o.kt)("h2",{id:"os-versions-are-missing-in-osinfo-query-os"},"OS versions are missing in ",(0,o.kt)("inlineCode",{parentName:"h2"},"osinfo-query os")),(0,o.kt)("p",null,"You need to update your osinfo database :"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Install the package ",(0,o.kt)("inlineCode",{parentName:"li"},"osinfo-db-tools")," on your system"),(0,o.kt)("li",{parentName:"ol"},"Download the last version of the ",(0,o.kt)("inlineCode",{parentName:"li"},"osinfo-db-<version>.tar.xz")," database. You may check the last version by visiting the ",(0,o.kt)("a",{parentName:"li",href:"https://releases.pagure.org/libosinfo/"},"libosinfo index site ","[","?","]")," :")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'wget -O "/tmp/osinfo-db.tar.xz" "https://releases.pagure.org/libosinfo/osinfo-db-20220214.tar.xz"\nsudo osinfo-db-import --local /tmp/osinfo-db.tar.xz\nosinfo-query os  # the os list should be updated \n')),(0,o.kt)("h2",{id:"policykit"},"PolicyKit"),(0,o.kt)("p",null,"libvirt has a policy in ",(0,o.kt)("inlineCode",{parentName:"p"},"/usr/share/polkit-1/rules.d/60-libvirt.rules")," that allows the users taking part to the group\n",(0,o.kt)("inlineCode",{parentName:"p"},"libvirt")," to manage virtual machines."),(0,o.kt)("h2",{id:"run-tests"},"Run tests"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"poetry run pytest --cov=freyja freyja/tests/\n")),(0,o.kt)("h2",{id:"run-build"},"Run build"),(0,o.kt)("p",null,"Install Poetry."),(0,o.kt)("p",null,"Then run :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"./build.sh\n")))}d.isMDXComponent=!0}}]);